name: Build Validator Binaries

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: false
        type: string
  push:
    tags:
      - 'v*'
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-binaries:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux (for containers - K8S)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux-amd64
            ext: so
            cross: false
            container_platform: linux/amd64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            platform: linux-arm64
            ext: so
            cross: true
            container_platform: linux/arm64
          - os: ubuntu-latest
            target: armv7-unknown-linux-gnueabihf
            platform: linux-armv7
            ext: so
            cross: true
            container_platform: linux/arm/v7
          # Windows (for developer workstations)
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows-amd64
            ext: dll
            cross: false
            container_platform: ""
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            platform: windows-arm64
            ext: dll
            cross: false
            container_platform: ""
          # macOS (for developer workstations)
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: darwin-amd64
            ext: dylib
            cross: false
            container_platform: ""
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: darwin-arm64
            ext: dylib
            cross: false
            container_platform: ""
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout BRRTRouter
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ -n "${{ github.ref }}" ] && [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="dev-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (for cross-compilation)
        if: matrix.cross == true
        run: |
          cargo install cross --git https://github.com/cross-rs/cross

      - name: Install maturin
        run: |
          pip install maturin

      - name: Set up QEMU for cross-compilation
        if: matrix.cross == true
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.container_platform != '' && format('{0}', matrix.container_platform) || 'arm64,arm' }}

      - name: Install cross-compilation dependencies
        if: matrix.cross == true && matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          if [ "${{ matrix.target }}" = "armv7-unknown-linux-gnueabihf" ]; then
            sudo apt-get install -y gcc-arm-linux-gnueabihf
          elif [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu
          fi

      - name: Configure Cargo for cross-compilation
        if: matrix.cross == true
        working-directory: brrtrouter-validator-python
        run: |
          mkdir -p .cargo
          if [ "${{ matrix.target }}" = "armv7-unknown-linux-gnueabihf" ]; then
            cat > .cargo/config.toml <<'EOF'
          [target.armv7-unknown-linux-gnueabihf]
          linker = "arm-linux-gnueabihf-gcc"
          EOF
          elif [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
            cat > .cargo/config.toml <<'EOF'
          [target.aarch64-unknown-linux-gnu]
          linker = "aarch64-linux-gnu-gcc"
          EOF
          fi

      - name: Build wheel
        working-directory: brrtrouter-validator-python
        env:
          # Ensure maturin uses the correct target
          CARGO_BUILD_TARGET: ${{ matrix.target }}
          # For cross-compilation
          PKG_CONFIG_ALLOW_CROSS: "1"
        run: |
          echo "Building for target: ${{ matrix.target }}"
          echo "Container platform: ${{ matrix.container_platform }}"
          echo "Cross-compilation: ${{ matrix.cross }}"
          
          # Ensure target is installed
          rustup target add ${{ matrix.target }}
          
          if [ "${{ matrix.cross }}" = "true" ]; then
            echo "Building for cross-compilation target: ${{ matrix.target }}"
            # Set linker environment variables for cross-compilation
            if [ "${{ matrix.target }}" = "armv7-unknown-linux-gnueabihf" ]; then
              export CC_armv7_unknown_linux_gnueabihf=arm-linux-gnueabihf-gcc
              export CARGO_TARGET_ARMV7_UNKNOWN_LINUX_GNUEABIHF_LINKER=arm-linux-gnueabihf-gcc
              export AR_armv7_unknown_linux_gnueabihf=arm-linux-gnueabihf-ar
            elif [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
              export CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
              export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
              export AR_aarch64_unknown_linux_gnu=aarch64-linux-gnu-ar
            fi
          fi
          
          maturin build --release --target ${{ matrix.target }}

      - name: Extract binary from wheel
        working-directory: brrtrouter-validator-python
        run: |
          python3 << 'EOF'
          import zipfile
          import glob
          import os
          import shutil
          
          whl_files = glob.glob('target/wheels/*.whl')
          if not whl_files:
              print("❌ No wheel files found")
              exit(1)
          
          whl = whl_files[0]
          print(f"Processing wheel: {os.path.basename(whl)}")
          z = zipfile.ZipFile(whl)
          so_files = [f for f in z.namelist() if '.so' in f or '.dylib' in f or '.dll' in f]
          if not so_files:
              print("❌ No binary files found in wheel")
              print("Files in wheel:")
              for f in z.namelist()[:20]:
                  print(f"  - {f}")
              exit(1)
          
          so_file = so_files[0]
          print(f"Found binary: {so_file}")
          
          if os.path.exists('extracted'):
              shutil.rmtree('extracted')
          
          z.extract(so_file, 'extracted')
          extracted_path = os.path.join('extracted', so_file)
          
          if not os.path.exists(extracted_path):
              print(f"❌ Extraction failed: {extracted_path}")
              exit(1)
          
          platform_name = "${{ matrix.platform }}"
          ext = "${{ matrix.ext }}"
          output_name = f"brrtrouter_validator.{ext}"
          output_dir = f"binaries/{platform_name}"
          output_path = os.path.join(output_dir, output_name)
          
          os.makedirs(output_dir, exist_ok=True)
          shutil.copy2(extracted_path, output_path)
          
          print(f"✅ Binary copied to: {output_path}")
          print(f"   Size: {os.path.getsize(output_path):,} bytes")
          
          shutil.rmtree('extracted')
          EOF

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: brrtrouter-validator-${{ matrix.platform }}
          path: brrtrouter-validator-python/binaries/${{ matrix.platform }}/brrtrouter_validator.${{ matrix.ext }}
          retention-days: 7

  create-release-assets:
    needs: build-binaries
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.ref }}" ] && [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="dev-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create platform-specific archives
        run: |
          mkdir -p release
          # Container platforms (for K8S)
          for platform in linux-amd64 linux-arm64 linux-armv7; do
            if [ -f "artifacts/brrtrouter-validator-$platform/brrtrouter_validator"* ]; then
              mkdir -p "release/$platform"
              cp artifacts/brrtrouter-validator-$platform/* "release/$platform/"
              
              # Create platform-specific tar.gz
              cd "release/$platform"
              tar -czf "../../brrtrouter-validator-$platform-${{ steps.version.outputs.version }}.tar.gz" .
              cd ../..
              
              echo "✅ Created archive for $platform (container platform)"
            else
              echo "⚠️  No binary found for $platform"
            fi
          done
          
          # Developer workstation platforms
          for platform in windows-amd64 windows-arm64 darwin-amd64 darwin-arm64; do
            if [ -f "artifacts/brrtrouter-validator-$platform/brrtrouter_validator"* ]; then
              mkdir -p "release/$platform"
              cp artifacts/brrtrouter-validator-$platform/* "release/$platform/"
              
              # Create platform-specific tar.gz
              cd "release/$platform"
              tar -czf "../../brrtrouter-validator-$platform-${{ steps.version.outputs.version }}.tar.gz" .
              cd ../..
              
              echo "✅ Created archive for $platform (developer workstation)"
            else
              echo "⚠️  No binary found for $platform"
            fi
          done
          
          # Create combined archive with all platforms
          cd release
          tar -czf "../brrtrouter-validator-all-${{ steps.version.outputs.version }}.tar.gz" .
          cd ..
          
          # Create container-only archive (for K8S deployments)
          mkdir -p container-only
          for platform in linux-amd64 linux-arm64 linux-armv7; do
            if [ -d "release/$platform" ]; then
              cp -r "release/$platform" "container-only/"
            fi
          done
          cd container-only
          tar -czf "../brrtrouter-validator-containers-${{ steps.version.outputs.version }}.tar.gz" .
          cd ..

      - name: Create release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: BRRTRouter Validator ${{ steps.version.outputs.version }}
          body: |
            BRRTRouter Python Validator Binaries
            
            ## Platforms
            
            ### Container Platforms (K8S)
            - Linux AMD64 (`linux/amd64`)
            - Linux ARM64 (`linux/arm64`)
            - Linux ARMv7 (`linux/arm/v7`)
            
            ### Developer Workstations
            - Windows AMD64
            - Windows ARM64
            - macOS AMD64 (Intel)
            - macOS ARM64 (Apple Silicon)
            
            ## Usage
            
            Download the appropriate archive for your platform and extract:
            
            ```bash
            tar -xzf brrtrouter-validator-<platform>-<version>.tar.gz
            ```
            
            Or download the combined archive with all platforms:
            
            ```bash
            tar -xzf brrtrouter-validator-all-<version>.tar.gz
            ```
            
            ## Integration with bff-generator
            
            The bff-generator will automatically download these binaries during its release process.
          files: |
            brrtrouter-validator-*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to existing release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'release'
        with:
          files: |
            brrtrouter-validator-*.tar.gz
            brrtrouter-validator-containers-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
