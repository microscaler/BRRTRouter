# Automatically merge Dependabot PRs for minor/patch updates
# Only merges after CI passes
#
# This workflow:
# - Triggers on PR open/update and check_suite completion (not status)
# - Auto-merges minor/patch updates after CI passes
# - Comments on major updates requiring manual review
#
# We trigger on check_suite (completed) only, not status. GitHub sends one status
# event per status update (each job start/complete, codecov, etc.), so a single
# CI run could trigger this workflow 6+ times. check_suite fires once when the
# entire suite completes, so we run once per CI completion.
#
# Do not add job-level `if: github.actor == 'dependabot[bot]'`. On check_suite
# events the actor is the app that posted the check (e.g. github-actions), so
# that would skip the job and Dependabot PRs would never be auto-merged.

name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
  check_suite:
    types: [completed]

# One run per PR: cancel in-progress runs when a new event fires for the same PR
concurrency:
  group: dependabot-automerge-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  dependabot-automerge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (apt update && apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Set up tooling .venv
        run: |
          python3 -m venv tooling/.venv
          tooling/.venv/bin/pip install --upgrade pip
          tooling/.venv/bin/pip install -e ./tooling[dev]

      - name: Fetch Dependabot metadata (pull_request events)
        if: github.event_name == 'pull_request' && github.actor == 'dependabot[bot]'
        id: metadata-pr
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Process Dependabot PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          DEPENDENCY_NAMES: ${{ steps.metadata-pr.outputs.dependency-names }}
          UPDATE_TYPE: ${{ steps.metadata-pr.outputs.update-type }}
        run: |
          tooling/.venv/bin/brrtrouter dependabot automerge

